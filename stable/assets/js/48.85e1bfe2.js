(window.webpackJsonp=window.webpackJsonp||[]).push([[48],{444:function(e,t,a){"use strict";a.r(t);var i=a(15),r=Object(i.a)({},function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"zowe-api-mediation-layer-security"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#zowe-api-mediation-layer-security","aria-hidden":"true"}},[e._v("#")]),e._v(" Zowe API Mediation Layer Security")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#how-api-ml-transport-security-works"}},[e._v("How API ML transport security works")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#transport-layer-security"}},[e._v("Transport layer security")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#authentication"}},[e._v("Authentication")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#zowe-api-ml-services"}},[e._v("Zowe API ML services")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#zowe-api-ml-tls-requirements"}},[e._v("Zowe API ML TLS requirements")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#authentication-for-api-ml-services"}},[e._v("Authentication for API ML services")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#authentication-endpoints"}},[e._v("Authentication endpoints")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#authentication-providers"}},[e._v("Authentication providers")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#z-osmf-authentication-provider"}},[e._v("z/OSMF Authentication Provider")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#dummy-authentication-provider"}},[e._v("Dummy Authentication Provider")])])])])])]),e._v(" "),a("li",[a("a",{attrs:{href:"#authorization"}},[e._v("Authorization")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#jwt-token"}},[e._v("JWT Token")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#api-ml-truststore-and-keystore"}},[e._v("API ML truststore and keystore")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#authentication-to-the-discovery-service"}},[e._v("Authentication to the Discovery Service")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#setting-ciphers-for-api-ml-services"}},[e._v("Setting Ciphers for API ML Services")])])])]),e._v(" "),a("li",[a("a",{attrs:{href:"#certificate-management-in-zowe-api-mediation-layer"}},[e._v("Certificate management in Zowe API Mediation Layer")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#running-on-localhost"}},[e._v("Running on localhost")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#how-to-start-api-ml-on-localhost-with-full-https"}},[e._v("How to start API ML on localhost with full HTTPS")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#certificate-management-script"}},[e._v("Certificate management script")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#generate-certificates-for-localhost"}},[e._v("Generate certificates for localhost")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#generate-a-certificate-for-a-new-service-on-localhost"}},[e._v("Generate a certificate for a new service on localhost")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#add-a-service-with-an-existing-certificate-to-api-ml-on-localhost"}},[e._v("Add a service with an existing certificate to API ML on localhost")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#log-in-to-discovery-service-on-localhost"}},[e._v("Log in to Discovery Service on localhost")])])])]),e._v(" "),a("li",[a("a",{attrs:{href:"#zowe-runtime-on-z-os"}},[e._v("Zowe runtime on z/OS")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#certificates-for-z-os-installation-from-the-zowe-pax-file"}},[e._v("Certificates for z/OS installation from the Zowe PAX file")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#import-the-local-ca-certificate-to-your-browser"}},[e._v("Import the local CA certificate to your browser")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#generate-a-keystore-and-truststore-for-a-new-service-on-z-os"}},[e._v("Generate a keystore and truststore for a new service on z/OS")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#add-a-service-with-an-existing-certificate-to-api-ml-on-z-os"}},[e._v("Add a service with an existing certificate to API ML on z/OS")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#procedure-if-the-service-is-not-trusted"}},[e._v("Procedure if the service is not trusted")])])])]),e._v(" "),a("li",[a("a",{attrs:{href:"#trust-a-z-osmf-certificate"}},[e._v("Trust a z/OSMF certificate")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#disable-certificate-validation"}},[e._v("Disable certificate validation")])])])])])]),e._v(" "),a("li",[a("a",{attrs:{href:"#security-service-client-library"}},[e._v("Security Service Client library")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#@enableApimlAuth-annotation"}},[e._v("@EnableApimlAuth annotation")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#gateway-lookup-logic"}},[e._v("Gateway lookup logic")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#useful-classes"}},[e._v("Useful classes")])])])])]),e._v(" "),a("h2",{attrs:{id:"how-api-ml-transport-security-works"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#how-api-ml-transport-security-works","aria-hidden":"true"}},[e._v("#")]),e._v(" How API ML transport security works")]),e._v(" "),a("p",[e._v("Security within the API Mediaiton Layer (API ML) is performed on several levels. This article describes how API ML uses Transport Layer Security (TLS). As a system administrator or API developer, use this guide to familiarize yourself with the following security concepts:")]),e._v(" "),a("h3",{attrs:{id:"transport-layer-security"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#transport-layer-security","aria-hidden":"true"}},[e._v("#")]),e._v(" Transport layer security")]),e._v(" "),a("p",[e._v("Secure data during data-transport by using the TLS protocol for all connections to API Mediation Layer services. While it is possible to disable the TLS protocol for debugging purposes or other use-cases, the enabled TLS protocol is the default mode.")]),e._v(" "),a("h3",{attrs:{id:"authentication"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#authentication","aria-hidden":"true"}},[e._v("#")]),e._v(" Authentication")]),e._v(" "),a("p",[e._v("Authentication is the method of how an entity, whether it be a user (API Client) or an application (API Service), proves its true identity.")]),e._v(" "),a("p",[e._v("API ML uses the following authentication methods:")]),e._v(" "),a("ul",[a("li",[a("p",[a("strong",[e._v("User ID and password")])]),e._v(" "),a("ul",[a("li",[e._v("The user ID and password are used to retrieve authentication tokens.")]),e._v(" "),a("li",[e._v("Requests originate from a user.")]),e._v(" "),a("li",[e._v("The user ID and password are validated by a z/OS security manager and\na token is issued that is then used to access the API service.")])])]),e._v(" "),a("li",[a("p",[a("strong",[e._v("TLS client certificates")])]),e._v(" "),a("ul",[a("li",[e._v("Certificates are for service-only requests.")])])])]),e._v(" "),a("h3",{attrs:{id:"zowe-api-ml-services"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#zowe-api-ml-services","aria-hidden":"true"}},[e._v("#")]),e._v(" Zowe API ML services")]),e._v(" "),a("p",[e._v("The following range of service types apply to the Zowe API ML:")]),e._v(" "),a("ul",[a("li",[a("p",[a("strong",[e._v("Zowe API ML services")])]),e._v(" "),a("ul",[a("li",[a("p",[a("strong",[e._v("Gateway Service (GW)")]),e._v("\nThe Gateway is the access point for API clients that require access to API services.\nAPI services can be accessed through the Gateway by API Clients. The Gateway receives information about an API Service\nfrom the Discovery Service.")])]),e._v(" "),a("li",[a("p",[a("strong",[e._v("Discovery Service (DS)")]),e._v("\nThe Discovery Service collects information about API services and provides this information to the Gateway\nand other services. API ML internal services are also registered to the Discovery Service.")])]),e._v(" "),a("li",[a("p",[a("strong",[e._v("API Catalog (AC)")]),e._v("\nThe Catalog displays information about API services through a web UI. The Catalog receives information\nabout an API service from the Discovery Service.")])])])]),e._v(" "),a("li",[a("p",[a("strong",[e._v("Authentication and Authorization Service (AAS)")])]),e._v(" "),a("p",[e._v("AAS provides authentication and authorization functionality to check user access to resources on z/OS.\nThe API ML uses z/OSMF API for  authentication. For more information, see: "),a("a",{attrs:{href:"https://github.com/zowe/api-layer/wiki/Zowe-Authentication-and-Authorization-Service",target:"_blank",rel:"noopener noreferrer"}},[e._v("APIML wiki"),a("OutboundLink")],1)])]),e._v(" "),a("li",[a("p",[a("strong",[e._v("API Clients")])]),e._v(" "),a("p",[e._v("External applications, users, or other API services that are accessing API services via the API Gateway")])]),e._v(" "),a("li",[a("p",[a("strong",[e._v("API Services")])]),e._v(" "),a("p",[e._v("Applications that are accessed through the API Gateway. API services register themselves to the\nDiscovery Service and can access other services through the Gateway. If an API service is installed\nin such a way that direct access is possible, API services can access other services without the Gateway.\nWhen APIs access other services, they can also function as API clients.")])])]),e._v(" "),a("h3",{attrs:{id:"zowe-api-ml-tls-requirements"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#zowe-api-ml-tls-requirements","aria-hidden":"true"}},[e._v("#")]),e._v(" Zowe API ML TLS requirements")]),e._v(" "),a("p",[e._v("The API ML TLS requires servers to provide HTTPS ports. Each of the API ML services has the following specific requirements:")]),e._v(" "),a("ul",[a("li",[a("p",[a("strong",[e._v("API Client")])]),e._v(" "),a("ul",[a("li",[e._v("The API Client is not a server")]),e._v(" "),a("li",[e._v("Requires trust of the API Gateway")]),e._v(" "),a("li",[e._v("Has a truststore that contains certificates required to trust the Gateway")])])]),e._v(" "),a("li",[a("p",[a("strong",[e._v("Gateway Service")])]),e._v(" "),a("ul",[a("li",[e._v("Provides an HTTPS port")]),e._v(" "),a("li",[e._v("Has a keystore with a server certificate\n"),a("ul",[a("li",[e._v("The certificate needs to be trusted by API Clients")]),e._v(" "),a("li",[e._v("This certificate should be trusted by web browsers because the API Gateway can be used to display web UIs")])])]),e._v(" "),a("li",[e._v("Has a truststore that contains certificates needed to trust API Services")])])]),e._v(" "),a("li",[a("p",[a("strong",[e._v("API Catalog")])]),e._v(" "),a("ul",[a("li",[e._v("Provides an HTTPS port")]),e._v(" "),a("li",[e._v("Has a keystore with a server certificate\n"),a("ul",[a("li",[e._v("The certificate needs to be trusted by the API Gateway")]),e._v(" "),a("li",[e._v("This certificate does not need to be trusted by anyone else")])])])])]),e._v(" "),a("li",[a("p",[a("strong",[e._v("Discovery Service")])]),e._v(" "),a("ul",[a("li",[e._v("Provides an HTTPS port")]),e._v(" "),a("li",[e._v("Has a keystore with a server certificate\n"),a("ul",[a("li",[e._v("The certificate needs to be trusted by API Clients")])])]),e._v(" "),a("li",[e._v("Has a truststore that contains certificates needed to trust API services")])])]),e._v(" "),a("li",[a("p",[a("strong",[e._v("API Service")])]),e._v(" "),a("ul",[a("li",[e._v("Provides an HTTPS port")]),e._v(" "),a("li",[e._v("Has a keystore with a server and client certificate\n"),a("ul",[a("li",[e._v("The server certificate needs to be trusted by the Gateway")]),e._v(" "),a("li",[e._v("The client certificate needs to be trusted by the Discovery Service")]),e._v(" "),a("li",[e._v("The client and server certificates can be the same")]),e._v(" "),a("li",[e._v("These certificates do not need to be trusted by anyone else")])])]),e._v(" "),a("li",[e._v("Has a truststore that contains one or more certificates that are required to trust the Gateway and Discovery Service")])])])]),e._v(" "),a("h3",{attrs:{id:"authentication-for-api-ml-services"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#authentication-for-api-ml-services","aria-hidden":"true"}},[e._v("#")]),e._v(" Authentication for API ML services")]),e._v(" "),a("ul",[a("li",[a("p",[a("strong",[e._v("API Gateway")])]),e._v(" "),a("ul",[a("li",[e._v("API Gateway handles authentication.")]),e._v(" "),a("li",[e._v("There are two authentication endpoints that allow to authenticate the resource by providers")]),e._v(" "),a("li",[e._v("Diagnostic endpoints "),a("code",[e._v("/application/**")]),e._v(" in API Gateway are protected by basic authentication or Zowe JWT token.")])])]),e._v(" "),a("li",[a("p",[a("strong",[e._v("API Catalog")])]),e._v(" "),a("ul",[a("li",[e._v("API Catalog is accessed by users and requires protection by a login")]),e._v(" "),a("li",[e._v("Protected access is performed by the Authentication and Authorization Service")])])]),e._v(" "),a("li",[a("p",[a("strong",[e._v("Discovery Service")])]),e._v(" "),a("ul",[a("li",[e._v("Discovery Service is accessed by API Services")]),e._v(" "),a("li",[e._v("This access (reading information and registration) requires protection needs by a client certificate")]),e._v(" "),a("li",[e._v("(Optional) Access can be granted to users (administrators)")])])]),e._v(" "),a("li",[a("p",[a("strong",[e._v("API Services")])]),e._v(" "),a("ul",[a("li",[e._v("Authentication is service-dependent")]),e._v(" "),a("li",[e._v("Recommended to use the Authentication and Authorization Service for authentication")])])])]),e._v(" "),a("h4",{attrs:{id:"authentication-endpoints"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#authentication-endpoints","aria-hidden":"true"}},[e._v("#")]),e._v(" Authentication endpoints")]),e._v(" "),a("p",[e._v("The API Gateway contains two REST API authentication endpoints: "),a("code",[e._v("auth/login")]),e._v(" and "),a("code",[e._v("auth/query")]),e._v(".")]),e._v(" "),a("p",[e._v("The "),a("code",[e._v("/login")]),e._v(" endpoint allows to authenticate mainframe user credentials and returns an authentication token. The login request requires the user credentials in one of the following formats:")]),e._v(" "),a("ul",[a("li",[e._v("Basic access authentication")]),e._v(" "),a("li",[e._v("JSON with user credentials")])]),e._v(" "),a("ol",[a("li",[e._v("When successfully authenticated, the response to the request is an empty body and a token in a secure "),a("code",[e._v("HttpOnly")]),e._v(" cookie named "),a("code",[e._v("apimlAuthenticationToken")]),e._v(".")]),e._v(" "),a("li",[e._v("When authentication failed, a user gets 401 status code.")])]),e._v(" "),a("p",[e._v("The "),a("code",[e._v("/query")]),e._v(" endpoint allows to validate the token and retrieves the information associated with the token.\nThe query request requires the token in one of the following formats:")]),e._v(" "),a("ul",[a("li",[e._v("Cookie named "),a("code",[e._v("apimlAuthenticationToken")])]),e._v(" "),a("li",[e._v("Bearer authentication")])]),e._v(" "),a("ol",[a("li",[e._v("When successfully authenticated, the response to the request is a JSON object, which contains information associated with the token")]),e._v(" "),a("li",[e._v("When authentication failed, a user gets 401 status code.")])]),e._v(" "),a("h4",{attrs:{id:"authentication-providers"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#authentication-providers","aria-hidden":"true"}},[e._v("#")]),e._v(" Authentication providers")]),e._v(" "),a("p",[e._v("API ML contains the following providers to handle authentication for the API Gateway:")]),e._v(" "),a("ul",[a("li",[a("code",[e._v("z/OSMF Authentication Provider")])]),e._v(" "),a("li",[a("code",[e._v("Dummy Authentication Provider")])])]),e._v(" "),a("h5",{attrs:{id:"z-osmf-authentication-provider"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#z-osmf-authentication-provider","aria-hidden":"true"}},[e._v("#")]),e._v(" z/OSMF Authentication Provider")]),e._v(" "),a("p",[e._v("The "),a("code",[e._v("z/OSMF Authentication Provider")]),e._v(" allows API Gateway to authenticate with the z/OSMF service. The user needs z/OSMF access in order to authenticate.")]),e._v(" "),a("p",[e._v("Use the following properties of API Gateway to enable the "),a("code",[e._v("z/OSMF Authentication Provider")]),e._v(":")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("apiml.security.auth.provider: zosmf\napiml.security.auth.zosmfServiceId: zosmf  # Replace me with the correct z/OSMF service id\n")])])]),a("h5",{attrs:{id:"dummy-authentication-provider"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dummy-authentication-provider","aria-hidden":"true"}},[e._v("#")]),e._v(" Dummy Authentication Provider")]),e._v(" "),a("p",[e._v("The "),a("code",[e._v("Dummy Authentication Provider")]),e._v(" implements simple authentication for development purpose using dummy credentials (username:  "),a("code",[e._v("user")]),e._v(", password "),a("code",[e._v("user")]),e._v("). The "),a("code",[e._v("Dummy Authentication Provider")]),e._v(" allows API Gateway to run without authenticating with the z/OSMF service.")]),e._v(" "),a("p",[e._v("Use the following property of API Gateway to enable the "),a("code",[e._v("Dummy Authentication Provider")]),e._v(":")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("apiml.security.auth.provider: dummy\n")])])]),a("h3",{attrs:{id:"authorization"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#authorization","aria-hidden":"true"}},[e._v("#")]),e._v(" Authorization")]),e._v(" "),a("p",[e._v("Authorization is a method used to determine access rights of an entity.")]),e._v(" "),a("p",[e._v("In the API ML, authorization is performed by the z/OS security manager ("),a("a",{attrs:{href:"https://www.ca.com/us/products/ca-acf2.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("CA ACF2"),a("OutboundLink")],1),e._v(", "),a("a",{attrs:{href:"https://www.ibm.com/support/knowledgecenter/zosbasics/com.ibm.zos.zsecurity/zsecc_042.htm",target:"_blank",rel:"noopener noreferrer"}},[e._v("IBM RACF"),a("OutboundLink")],1),e._v(", "),a("a",{attrs:{href:"https://www.ca.com/us/products/ca-top-secret.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("CA Top Secret"),a("OutboundLink")],1),e._v("). An authentication token is used as proof of valid authentication. The authorization checks, however, are always performed by the z/OS security manager.")]),e._v(" "),a("h3",{attrs:{id:"jwt-token"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#jwt-token","aria-hidden":"true"}},[e._v("#")]),e._v(" JWT Token")]),e._v(" "),a("p",[e._v('The JWT Secret that signs the JWT Token is an asymmetric private key that is generated during installation. You can find the JWT Secret, alias "jwtsecret", in the  PKCS12 keystore /keystore/localhost/localhost.keystore.p12. The public key necessary to read the JWT Secret is called from the keystore. For easy access, you can find the public key in the '),a("code",[e._v("localhost.keystore.jwtsecret.cer")]),e._v(" directory. The JWT token is signed with the RS256 signature algorithm.")]),e._v(" "),a("h3",{attrs:{id:"api-ml-truststore-and-keystore"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#api-ml-truststore-and-keystore","aria-hidden":"true"}},[e._v("#")]),e._v(" API ML truststore and keystore")]),e._v(" "),a("p",[e._v("A "),a("em",[e._v("keystore")]),e._v(" is a repository of security certificates consisting of either authorization certificates or public key certificates with corresponding private keys (PK), used in TLS encryption. A "),a("em",[e._v("keystore")]),e._v(" can be stored in Java specific format (JKS) or use the standard format (PKCS12). The Zowe API ML uses PKCS12 to enable the keystores to be used\nby other technologies used in Zowe (Node.js).")]),e._v(" "),a("p",[a("strong",[e._v("The API ML local certificate authority (CA)")])]),e._v(" "),a("ul",[a("li",[e._v("The API ML local CA contains a local CA certificate and a private key that needs to be securely stored")]),e._v(" "),a("li",[e._v("Used to sign certificates of services")]),e._v(" "),a("li",[e._v("The API ML local CA certificate is trusted by API services and clients")])]),e._v(" "),a("p",[a("strong",[e._v("The API ML keystore")])]),e._v(" "),a("ul",[a("li",[e._v("Server certificate of the Gateway (with PK). This can be signed by the local CA or an external CA")]),e._v(" "),a("li",[e._v("Server certificate of the Discovery Service (with PK). This can be signed by the local CA")]),e._v(" "),a("li",[e._v("Server certificate of the Catalog (with PK). This can be signed by the local CA")]),e._v(" "),a("li",[e._v("Private asymmetric key for the JWT token, alias "),a("code",[e._v("jwtsecret")]),e._v(". The  public key is exported to the "),a("code",[e._v("localhost.keystore.jwtsecret.cer")]),e._v(" directory.")]),e._v(" "),a("li",[e._v("The API ML keystore is used by API ML services")])]),e._v(" "),a("p",[a("strong",[e._v("The API ML truststore")])]),e._v(" "),a("ul",[a("li",[e._v("The API ML truststore contains a local CA public certificate")]),e._v(" "),a("li",[e._v("Contains an external CA public certificate (optional)")]),e._v(" "),a("li",[e._v("Can contain self-signed certificates of API Services that are not signed by the local or external CA")]),e._v(" "),a("li",[e._v("Used by API ML services")])]),e._v(" "),a("p",[a("strong",[e._v("Zowe core services")])]),e._v(" "),a("ul",[a("li",[e._v("Services can use the same keystore and truststore as APIML for simpler installation and management")]),e._v(" "),a("li",[e._v("Alternatively, services can have individual stores for higher security")])]),e._v(" "),a("p",[a("strong",[e._v("API service keystore")]),e._v(" (for each service)")]),e._v(" "),a("ul",[a("li",[e._v("Contains a server and client certificate signed by the local CA")])]),e._v(" "),a("p",[a("strong",[e._v("API service truststore")]),e._v(" (for each service)")]),e._v(" "),a("ul",[a("li",[e._v("(Optional) Contains a local CA and external CA certificates")])]),e._v(" "),a("p",[a("strong",[e._v("Client certificates")])]),e._v(" "),a("ul",[a("li",[e._v("A client certificate is a certificate that is used for validation of the HTTPS client. The client certificate of a Discovery Service client can be the same certificate as the server certificate of the services which the Discovery Service client uses.")])]),e._v(" "),a("h3",{attrs:{id:"authentication-to-the-discovery-service"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#authentication-to-the-discovery-service","aria-hidden":"true"}},[e._v("#")]),e._v(" Authentication to the Discovery Service")]),e._v(" "),a("p",[e._v("The Discovery Service has the following types of users that require authentication:")]),e._v(" "),a("ul",[a("li",[a("p",[a("strong",[e._v("Administrators and developers who need to log in to the homepage of the Discovery Service")])]),e._v(" "),a("p",[e._v("The access is protected by a certificate.")])]),e._v(" "),a("li",[a("p",[a("strong",[e._v("Services that need to register to the Discovery Service")])]),e._v(" "),a("p",[e._v("These services are not users that have a user ID and password but are other services. They authenticate using client certificate. The client certificate is the same TLS certificate that the service uses for HTTPS communication.")])])]),e._v(" "),a("h3",{attrs:{id:"setting-ciphers-for-api-ml-services"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#setting-ciphers-for-api-ml-services","aria-hidden":"true"}},[e._v("#")]),e._v(" Setting ciphers for API ML services")]),e._v(" "),a("p",[e._v("You can override ciphers that are used by the HTTPS servers in API ML services by configuring properties of the gateway, discovery service, and API catalog.")]),e._v(" "),a("p",[a("strong",[e._v("Note:")]),e._v(" You do not need to rebuild JAR files when you override the default values in shell scirpts.")]),e._v(" "),a("p",[e._v("The "),a("em",[e._v("application.yml")]),e._v(" file contains the default value for each service, and can be found "),a("a",{attrs:{href:"https://github.com/zowe/api-layer/blob/master/gateway-service/src/main/resources/application.yml",target:"_blank",rel:"noopener noreferrer"}},[e._v("here"),a("OutboundLink")],1),e._v(". The default configuration is packed in .jar files. On z/OS, you can override the default configuration in "),a("code",[e._v("$ZOWE_ROOT_DIR/api-mediation/scripts/api-mediation-start-*.sh")]),e._v(", where "),a("code",[e._v("*")]),e._v(" expands to "),a("code",[e._v("gateway")]),e._v(", "),a("code",[e._v("catalog")]),e._v(", and "),a("code",[e._v("discovery")]),e._v(".\nAdd the launch parameter of the shell script to set a cipher:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("-Dapiml.security.ciphers=<cipher-list>\n")])])]),a("p",[e._v("On localhost, you can override the default configuration in "),a("a",{attrs:{href:"https://github.com/zowe/api-layer/blob/master/config/local/gateway-service.yml",target:"_blank",rel:"noopener noreferrer"}},[e._v("config/local/gateway-service.yml"),a("OutboundLink")],1),e._v(" (including other YAML files for development purposes).")]),e._v(" "),a("p",[e._v("The following list shows default ciphers. The API ML services use the following cipher order:")]),e._v(" "),a("p",[a("strong",[e._v("Note:")]),e._v(" Ensure that the version of Java you use is compatible with the default cipherset.")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("   TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,\n   TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,\n   TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256,TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256,\n   TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384\n")])])]),a("p",[e._v("Only IANA ciphers names are supported. For more information, see "),a("a",{attrs:{href:"https://wiki.mozilla.org/Security/Server_Side_TLS#Cipher_suites",target:"_blank",rel:"noopener noreferrer"}},[e._v("Cipher Suites"),a("OutboundLink")],1),e._v(" or "),a("a",{attrs:{href:"https://testssl.net/openssl-iana.mapping.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("List of Ciphers"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("h2",{attrs:{id:"certificate-management-in-zowe-api-mediation-layer"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#certificate-management-in-zowe-api-mediation-layer","aria-hidden":"true"}},[e._v("#")]),e._v(" Certificate management in Zowe API Mediation Layer")]),e._v(" "),a("h3",{attrs:{id:"running-on-localhost"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#running-on-localhost","aria-hidden":"true"}},[e._v("#")]),e._v(" Running on localhost")]),e._v(" "),a("h4",{attrs:{id:"how-to-start-api-ml-on-localhost-with-full-https"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#how-to-start-api-ml-on-localhost-with-full-https","aria-hidden":"true"}},[e._v("#")]),e._v(" How to start API ML on localhost with full HTTPS")]),e._v(" "),a("p",[e._v("The https://github.com/zowe/api-layer repository already contains pre-generated certificates that can be used to start API ML with HTTPS on your computer. The certificates are not trusted by your browser so you can either ignore the security warning or generate your own certificates and add them to the truststore of your browser or system.")]),e._v(" "),a("p",[e._v("The certificates are described in more detail in the https://github.com/zowe/api-layer/blob/master/keystore/README.md.")]),e._v(" "),a("h4",{attrs:{id:"certificate-management-script"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#certificate-management-script","aria-hidden":"true"}},[e._v("#")]),e._v(" Certificate management script")]),e._v(" "),a("p",[e._v("Zowe API Mediation Layer provides a script that can used on Windows, Mac, Linux, and z/OS\nto generate a certificate and keystore for the local CA, API Mediation Layer, and services.")]),e._v(" "),a("p",[e._v("This script is stored in "),a("a",{attrs:{href:"https://github.com/zowe/api-layer/blob/master/scripts/apiml_cm.sh",target:"_blank",rel:"noopener noreferrer"}},[e._v("scripts/apiml_cm.sh"),a("OutboundLink")],1),e._v(".\nIt is a UNIX shell script that can be executed by Bash or z/OS Shell. For Windows, install Bash by going to the following link: "),a("a",{attrs:{href:"http://cmder.net/",target:"_blank",rel:"noopener noreferrer"}},[e._v("cmder"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("h4",{attrs:{id:"generate-certificates-for-localhost"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#generate-certificates-for-localhost","aria-hidden":"true"}},[e._v("#")]),e._v(" Generate certificates for localhost")]),e._v(" "),a("p",[e._v("Use the following script in the root of the "),a("code",[e._v("api-layer")]),e._v(" repository to generate certificates for localhost:")]),e._v(" "),a("p",[a("code",[e._v("scripts/apiml_cm.sh --action setup")])]),e._v(" "),a("p",[e._v("This script creates the certificates and keystore for the API Mediation Layer in your current workspace.")]),e._v(" "),a("h4",{attrs:{id:"generate-a-certificate-for-a-new-service-on-localhost"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#generate-a-certificate-for-a-new-service-on-localhost","aria-hidden":"true"}},[e._v("#")]),e._v(" Generate a certificate for a new service on localhost")]),e._v(" "),a("p",[e._v("To generate a certificate for a new service on localhost, see\nhttps://github.com/zowe/api-layer/blob/master/keystore/README.md#generating-certificate-for-a-new-service-on-localhost")]),e._v(" "),a("h4",{attrs:{id:"add-a-service-with-an-existing-certificate-to-api-ml-on-localhost"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#add-a-service-with-an-existing-certificate-to-api-ml-on-localhost","aria-hidden":"true"}},[e._v("#")]),e._v(" Add a service with an existing certificate to API ML on localhost")]),e._v(" "),a("p",[e._v("The instructions are described at:\nhttps://github.com/zowe/api-layer/blob/master/keystore/README.md#trust-certificates-of-other-services")]),e._v(" "),a("h4",{attrs:{id:"log-in-to-discovery-service-on-localhost"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#log-in-to-discovery-service-on-localhost","aria-hidden":"true"}},[e._v("#")]),e._v(" Log in to Discovery Service on localhost")]),e._v(" "),a("p",[e._v("To access Discovery Service on localhost provide a valid client certificate.")]),e._v(" "),a("p",[e._v("The certificate is stored in the "),a("code",[e._v("keystore/localhost/localhost.keystore.p12")]),e._v(" keystore.")]),e._v(" "),a("p",[e._v("Some utilities including HTTPie require the certificate to be in PEM format. You can find it in "),a("code",[e._v("keystore/localhost/localhost.pem")]),e._v(".")]),e._v(" "),a("p",[e._v("Since the Discovery Service is using HTTPS, your client also requires verification of the validity of its certificate. Verification is performed by trusting the local CA certificate which is store at "),a("code",[e._v("keystore/local_ca/localca.cer")]),e._v(".")]),e._v(" "),a("p",[e._v("The following is an example of how to access Discovery Service from CLI with full certificate validation:")]),e._v(" "),a("p",[a("code",[e._v("http --cert=keystore/localhost/localhost.pem --verify=keystore/local_ca/localca.cer -j GET https://localhost:10011/eureka/apps/")])]),e._v(" "),a("h3",{attrs:{id:"zowe-runtime-on-z-os"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#zowe-runtime-on-z-os","aria-hidden":"true"}},[e._v("#")]),e._v(" Zowe runtime on z/OS")]),e._v(" "),a("h4",{attrs:{id:"certificates-for-z-os-installation-from-the-zowe-pax-file"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#certificates-for-z-os-installation-from-the-zowe-pax-file","aria-hidden":"true"}},[e._v("#")]),e._v(" Certificates for z/OS installation from the Zowe PAX file")]),e._v(" "),a("p",[e._v("Certificates for the API ML local CA and API ML service are automatically generated by installing the Zowe runtime on z/OS from the PAX file. Following the instructions in "),a("router-link",{attrs:{to:"/user-guide/install-zos.html"}},[e._v("Installing the Zowe runtime on z/OS")])],1),e._v(" "),a("p",[e._v("These certificates are generated by the certificate management script "),a("code",[e._v("apiml_cm.sh")]),e._v(" that is installed to "),a("code",[e._v("$ZOWE_ROOT_DIR/api-mediation/scripts/apiml_cm.sh")]),e._v(".")]),e._v(" "),a("p",[a("code",[e._v("$ZOWE_ROOT_DIR")]),e._v(" is the directory where you installed the Zowe runtime.")]),e._v(" "),a("p",[e._v("The certificates are generated to the directory "),a("code",[e._v("$ZOWE_ROOT_DIR/api-mediation/keystore")]),e._v(".")]),e._v(" "),a("p",[e._v("API ML keystore and truststore:")]),e._v(" "),a("ul",[a("li",[a("p",[a("code",[e._v("$ZOWE_ROOT_DIR/api-mediation/keystore/local/localhost.keystore.p12")])]),e._v(" "),a("ul",[a("li",[e._v("used for the HTTPS servers")]),e._v(" "),a("li",[e._v("contains the APIML server certificate signed by the local CA and private key for the server")])])]),e._v(" "),a("li",[a("p",[a("code",[e._v("$ZOWE_ROOT_DIR/api-mediation/keystore/local/localhost.truststore.p12")])]),e._v(" "),a("ul",[a("li",[e._v("use to validate trust when communicating with the services that are registered to the APIML")]),e._v(" "),a("li",[e._v("contains the root certificate of the local CA (not the server certificate)")]),e._v(" "),a("li",[e._v("contains the local CA public certificate")]),e._v(" "),a("li",[e._v("can contain additional certificate to trust services that are not signed by local CA")])])])]),e._v(" "),a("p",[e._v("API ML keystores and truststores needs be accessible by the user ID that executes the Zowe runtime.")]),e._v(" "),a("p",[e._v("Local CA:")]),e._v(" "),a("ul",[a("li",[a("p",[a("code",[e._v("$ZOWE_ROOT_DIR/api-mediation/keystoree/local_ca/localca.cer")])]),e._v(" "),a("ul",[a("li",[e._v("public certificate of local CA")])])]),e._v(" "),a("li",[a("p",[a("code",[e._v("$ZOWE_ROOT_DIR/api-mediation/keystore/local_ca/localca.keystore.p12")])]),e._v(" "),a("ul",[a("li",[e._v("private key of the local CA")])])])]),e._v(" "),a("p",[e._v("The local CA keystore is only accessible by the user that is installs and manages the Zowe runtime.")]),e._v(" "),a("h4",{attrs:{id:"import-the-local-ca-certificate-to-your-browser"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#import-the-local-ca-certificate-to-your-browser","aria-hidden":"true"}},[e._v("#")]),e._v(" Import the local CA certificate to your browser")]),e._v(" "),a("p",[e._v("Trust in the API ML server is a necessary precondition to properly encrypt traffic between web browsers and REST API client applications. Ensure this trust through the installation of a Certificate Authority (CA) public certificate. By default, API ML creates a local CA. Import the CA public certificate to the truststore for REST API clients and to your browser. You can also import the certificate to your root certificate store.")]),e._v(" "),a("p",[a("strong",[e._v("Note:")]),e._v(" The public certificate in the "),a("a",{attrs:{href:"https://en.wikipedia.org/wiki/Privacy-Enhanced_Mail",target:"_blank",rel:"noopener noreferrer"}},[e._v("PEM format"),a("OutboundLink")],1),e._v(" is stored at "),a("code",[e._v("$ZOWE_ROOT_DIR/api-mediation/keystore/local_ca/localca.cer")]),e._v(" where "),a("code",[e._v("$ZOWE_ROOT_DIR")]),e._v("  is the directory that was used for the Zowe runtime during installation.")]),e._v(" "),a("p",[e._v("The certificate is stored in UTF-8 encoding so you need to transfer it as a binary file. Since this is the certificate that your browser is going to trust, it is recommended to use a secure connection for transfer.")]),e._v(" "),a("p",[a("strong",[e._v("Follow these steps:")])]),e._v(" "),a("ol",[a("li",[a("p",[e._v("Download the local CA certificate to your computer. Use one of the following methods to download the local CA certificate to your computer:")]),e._v(" "),a("ul",[a("li",[a("strong",[e._v("Use "),a("a",{attrs:{href:"https://github.com/zowe/zowe-cli#zowe-cli--",target:"_blank",rel:"noopener noreferrer"}},[e._v("Zowe CLI"),a("OutboundLink")],1),e._v(" (Recommended)")]),e._v("\nIssue teh following command:")])]),e._v(" "),a("p",[a("code",[e._v("zowe zos-files download uss-file --binary $ZOWE_ROOT_DIR/api-mediation/keystore/local_ca/localca.cer")])]),e._v(" "),a("ul",[a("li",[a("strong",[e._v("Use "),a("code",[e._v("sftp")])]),e._v("\nIssue the following command:")])]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("sftp <system>\nget $ZOWE_ROOT_DIR/api-mediation/keystore/local_ca/localca.cer\n")])])]),a("p",[e._v("To verify that the file has been transferred correctly, open the file. The following heading and closing shoulf appear:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("-----BEGIN CERTIFICATE-----\n...\n-----END CERTIFICATE-----\n")])])])]),e._v(" "),a("li",[a("p",[e._v("Import the certificate to your root certificate store and trust it.")]),e._v(" "),a("ul",[a("li",[a("strong",[e._v("For Windows")]),e._v("\nRun the following command:")])]),e._v(" "),a("p",[a("code",[e._v('certutil -enterprise -f -v -AddStore "Root" localca.cer')])]),e._v(" "),a("p",[a("strong",[e._v("Note:")]),e._v(" Ensure that you open the terminal as "),a("strong",[e._v("administrator")]),e._v(". This will install the certificate to the Trusted Root Certification Authorities.")]),e._v(" "),a("ul",[a("li",[a("strong",[e._v("For macOS")]),e._v("\nRun the following command:")])]),e._v(" "),a("p",[a("code",[e._v("$ sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain localca.cer")])]),e._v(" "),a("ul",[a("li",[a("strong",[e._v("For Firefox")]),e._v("\nYou can manually import your root certificate via the Firefox settings, or force Firefox to use the Windows truststore:")])]),e._v(" "),a("p",[a("strong",[e._v("Note:")]),e._v(" Firefox uses its own certificate truststore.")]),e._v(" "),a("p",[e._v("Create a new Javascript file firefox-windows-truststore.js at "),a("code",[e._v("C:\\Program Files (x86)\\Mozilla Firefox\\defaults\\pref")]),e._v(" with the following content:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('/* Enable experimental Windows truststore support */\npref("security.enterprise_roots.enabled", true);\n')])])])])]),e._v(" "),a("h4",{attrs:{id:"generate-a-keystore-and-truststore-for-a-new-service-on-z-os"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#generate-a-keystore-and-truststore-for-a-new-service-on-z-os","aria-hidden":"true"}},[e._v("#")]),e._v(" Generate a keystore and truststore for a new service on z/OS")]),e._v(" "),a("p",[e._v("You can generate a keystore and truststore for a new service by calling the "),a("code",[e._v("apiml_cm.sh")]),e._v(" script in the directory with API Mediation Layer:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("cd $ZOWE_ROOT_DIR/api-mediation\nscripts/apiml_cm.sh --action new-service --service-alias <alias> --service-ext <ext> \\\n--service-keystore <keystore_path> --service-truststore <truststore_path> \\\n--service-dname <dname> --service-password <password> --service-validity <days> \\\n--local-ca-filename $ZOWE_ROOT_DIR/api-mediation/keystore/local_ca/localca \n")])])]),a("p",[e._v("The "),a("code",[e._v("service-alias")]),e._v(" is an unique string to identify the key entry. All keystore entries (key and trusted certificate entries) are accessed via unique aliases. Since the keystore will have only one certificate, you can omit this parameter and use the default value "),a("code",[e._v("localhost")]),e._v(".")]),e._v(" "),a("p",[e._v("The "),a("code",[e._v("service-keystore")]),e._v(" is a repository of security certificates plus corresponding private keys. The "),a("code",[e._v("<keystore_path>")]),e._v(" is the path excluding the extension to the keystore that will be generated. It can be an absolute path or a path relative to the current working directory. The key store is generated in PKCS12 format with "),a("code",[e._v(".p12")]),e._v(" extension. It should be path in an existing directory where your service expects the keystore. For example: "),a("code",[e._v("/opt/myservice/keystore/service.keystore")]),e._v(".")]),e._v(" "),a("p",[e._v("The "),a("code",[e._v("service-truststore")]),e._v(" contains certificates from other parties that you expect to communicate with, or from Certificate Authorities that you trust to identify other parties. The "),a("code",[e._v("<truststore_path>")]),e._v(" is the path excluding the extension to the trust store that will be generated. It can be an absolute path or a path relative to the current working directory. The truststore is generated in PKCS12 format.")]),e._v(" "),a("p",[e._v("The "),a("code",[e._v("service-ext")]),e._v(" specifies the X.509 extension that should be the Subject Alternate Name (SAN). The SAN has contain host names that are used to access the service. You need specify the same hostname that is used by the service during API Mediation Layer registration. For example:")]),e._v(" "),a("p",[a("code",[e._v('"SAN=dns:localhost.localdomain,dns:localhost,ip:127.0.0.1"')])]),e._v(" "),a("p",[a("strong",[e._v("Note:")]),e._v(" For more information about SAN, see "),a("em",[e._v("SAN or SubjectAlternativeName")]),e._v(" at "),a("a",{attrs:{href:"https://www.ibm.com/support/knowledgecenter/en/SSYKE2_8.0.0/com.ibm.java.security.component.80.doc/security-component/keytoolDocs/commonoptions.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("Java Keytool - Common Options"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("p",[e._v("The "),a("code",[e._v("service-dname")]),e._v(" is the X.509 Distinguished Name and is used to identify entities, such as those which are named by the subject and issuer (signer) fields of X.509 certificates. For example:")]),e._v(" "),a("p",[a("code",[e._v('"CN=Zowe Service, OU=API Mediation Layer, O=Zowe Sample, L=Prague, S=Prague, C=CZ"')])]),e._v(" "),a("p",[e._v("The "),a("code",[e._v("service-validity")]),e._v(" is the number of days after that the certificate will expire.")]),e._v(" "),a("p",[e._v("The "),a("code",[e._v("service-password")]),e._v(" is the keystore password. The purpose of the password is the integrity check. The access protection for the keystore and keystore need to be achieved by making them accessible only by the ZOVESVR user ID and the system administrator.")]),e._v(" "),a("p",[e._v("The "),a("code",[e._v("local-ca-filename")]),e._v(" is the path to the keystore that is used to sign your new certificate with the local CA private key. If you an in the "),a("code",[e._v("$ZOWE_RUNTIME/api-mediation-directory")]),e._v(", you can omit this parameter. It should point to the "),a("code",[e._v("$ZOWE_ROOT_DIR/api-mediation/keystore/local_ca/localca")]),e._v(".")]),e._v(" "),a("h4",{attrs:{id:"add-a-service-with-an-existing-certificate-to-api-ml-on-z-os"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#add-a-service-with-an-existing-certificate-to-api-ml-on-z-os","aria-hidden":"true"}},[e._v("#")]),e._v(" Add a service with an existing certificate to API ML on z/OS")]),e._v(" "),a("p",[e._v("The API Mediation Layer requires validation of the certificate of each service that it accessed by the API Mediation Layer. The API Mediation Layer requires validation of the full certificate chain. Use one of the following methods:")]),e._v(" "),a("ul",[a("li",[a("p",[e._v("Import the public certificate of the root CA that has signed the certificate of the service to the APIML truststore.")])]),e._v(" "),a("li",[a("p",[e._v("Ensure that your service has its own certificate. If it was signed by intermediate CA all intermediate CA certificates ensure that all certificates are in its keystore.")]),e._v(" "),a("p",[a("strong",[e._v("Note:")]),e._v(" If the service does not provide intermediate CA certificates to the APIML then the validation fails. This can be circumvented by importing the intermediate CA certificates to the API ML truststore.")])])]),e._v(" "),a("p",[e._v("Import a public certificate to the APIML truststore by calling in the directory with API Mediation Layer:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("cd $ZOWE_ROOT_DIR/api-mediation\nscripts/apiml_cm.sh --action trust --certificate <path-to-certificate-in-PEM-format> --alias <alias>\n")])])]),a("h5",{attrs:{id:"procedure-if-the-service-is-not-trusted"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#procedure-if-the-service-is-not-trusted","aria-hidden":"true"}},[e._v("#")]),e._v(" Procedure if the service is not trusted")]),e._v(" "),a("p",[e._v("If you access a service that is not trusted, for example, by issuing a REST API request to it:")]),e._v(" "),a("p",[a("code",[e._v("http --verify=keystore/local_ca/localca.cer GET https://<gatewayHost>:<port></port>/api/v1/<untrustedService>/greeting")])]),e._v(" "),a("p",[e._v("You will receive a similar response:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('    HTTP/1.1 502\n    Content-Type: application/json;charset=UTF-8\n\n    {\n        "messages": [\n            {\n                "messageContent": "The certificate of the service accessed by HTTPS using URI \'/api/v1/<untrustedService>/greeting\' is not trusted by the API Gateway: sun.security.validator.ValidatorException: PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target",\n                "messageKey": "apiml.common.tlsError",\n                "messageNumber": "AML0105",\n                "messageType": "ERROR"\n            }\n        ]\n    }\n')])])]),a("p",[e._v("The response has the HTTP status code "),a("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/502",target:"_blank",rel:"noopener noreferrer"}},[e._v("502 Bad Gateway"),a("OutboundLink")],1),e._v(" and a JSON response in the standardized format for error messages. The message has key "),a("code",[e._v("apiml.common.tlsError")]),e._v(" and the message number "),a("code",[e._v("AML0105")]),e._v(" and content that explains details about the message.")]),e._v(" "),a("p",[e._v("If you receive this message, import the certificate of your service or the CA that has signed it to the truststore of the API Mediation Layer as described above.")]),e._v(" "),a("h4",{attrs:{id:"trust-a-z-osmf-certificate"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#trust-a-z-osmf-certificate","aria-hidden":"true"}},[e._v("#")]),e._v(" Trust a z/OSMF certificate")]),e._v(" "),a("p",[e._v("The Zowe installation script tries to import z/OSMF public certificates to the truststore of API Mediation Layer automatically.  This requires the user ID that is doing the installation to be able to read the z/OSMF keyring.")]),e._v(" "),a("p",[e._v("If it is not possible, you will see following error message:")]),e._v(" "),a("p",[a("code",[e._v("WARNING: z/OSMF is not trusted by the API Mediation Layer.")])]),e._v(" "),a("p",[e._v("To allow "),a("code",[e._v("apiml_cm.sh")]),e._v(" to run, it should be sufficient to give CONTROL access for the user of "),a("code",[e._v("IRR.DIGTCERT.LIST")]),e._v(" (needed for a SITE certificate) and UPDATE access for the user of "),a("code",[e._v("IRR.DIGTCERT.LISTRING")]),e._v(", but in some cases (for example, you have already created a certificate), you might have to permit the user CONTROL access to "),a("code",[e._v("IRR.DIGTCERT.**")]),e._v(".")]),e._v(" "),a("p",[a("strong",[e._v("Follow these steps:")])]),e._v(" "),a("ol",[a("li",[e._v("Add z/OSMF to the truststore manually as a user that has access rights to read the z/OSMF keyring. The read access to z/OSMF keyring can be granted by the following commands:")])]),e._v(" "),a("ul",[a("li",[a("p",[e._v("RACF:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("PERMIT IRR.DIGTCERT.LIST CLASS(FACILITY) ID(acid) ACCESS(CONTROL)\nPERMIT IRR.DIGTCERT.LISTRING CLASS(FACILITY) ID(acid) ACCESS(UPDATE)\n")])])]),a("p",[e._v("To access the private key belonging to SITE or CERTAUTH in a keyring, you can use either the FACILITY class or the RDATALIB class.")]),e._v(" "),a("p",[e._v("If you use the FACILITY class, ensure that you have access rights to the following resources:")]),e._v(" "),a("ul",[a("li",[a("p",[a("code",[e._v("UPDATE")]),e._v(" access on "),a("code",[e._v("IRR.DIGTCERT.LISTRING")]),e._v(", and")])]),e._v(" "),a("li",[a("p",[a("code",[e._v("CONTROL")]),e._v(" access on "),a("code",[e._v("IRR.DIGTCERT.GENCERT")])])])]),e._v(" "),a("p",[e._v("If you use the RDATALIB class, ensure that you have access rights on the following resource:")]),e._v(" "),a("ul",[a("li",[a("code",[e._v("CONTROL")]),e._v(" access on "),a("code",[e._v("<keyring owner>.<ring name>.LST")])])]),e._v(" "),a("p",[a("strong",[e._v("Note:")]),e._v(" If you have both "),a("code",[e._v("FACILITY")]),e._v(" and "),a("code",[e._v("RDATALIB")]),e._v(" active, the access check will use the "),a("code",[e._v("RDATALIB")]),e._v(" class. If you do not have access to that specific profile, access is denied. It does not fall back to the "),a("code",[e._v("FACILITY")]),e._v(" class.")])]),e._v(" "),a("li",[a("p",[e._v("Top Secret:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("TSS ADD(dept) IBMFAC(IRR.DIGTCERT)\nTSS PER(acid) IBMFAC(IRR.DIGTCERT.LIST) ACCESS(CONTROL) \nTSS PER(acid) IBMFAC(IRR.DIGTCERT.LISTRING) ACCESS(UPDATE)\n")])])])]),e._v(" "),a("li",[a("p",[e._v("ACF2:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("  ACF \n  SET RESOURCE(FAC) \n  RECKEY IRR ADD(DIGTCERT.LIST UID(acid) - \n    SERVICE(CONTROL) ALLOW)                                           \n  RECKEY IRR ADD(DIGTCERT.LISTRING UID(acid) -  \n    SERVICE(UPDATE) ALLOW)\n  F ACF2,REBUILD(FAC) \n")])])]),a("p",[e._v("where:")]),e._v(" "),a("ul",[a("li",[a("code",[e._v("acid")]),e._v(" is the user ID of the user that is installing Zowe.")])])])]),e._v(" "),a("ol",{attrs:{start:"2"}},[a("li",[a("p",[e._v("Issue the following command to find the name of the z/OSMF keyring:")]),e._v(" "),a("p",[a("code",[e._v("cat /var/zosmf/configuration/servers/zosmfServer/bootstrap.properties | grep izu.ssl.key.store.saf.keyring")])]),e._v(" "),a("p",[e._v("This will return a line like the following one:")]),e._v(" "),a("p",[a("code",[e._v("izu.ssl.key.store.saf.keyring=IZUKeyring.IZUDFLT")])])]),e._v(" "),a("li",[a("p",[e._v("Run following commands as a superuser to import z/OSMF certificates:")]),e._v(" "),a("p",[a("strong",[e._v("Note:")]),e._v(" This should be the same keyring name as specified in the PARMLIB member for z/OSMF. For example, in SYS1.PARMLIB(IZUPRMxx) you will see a line like this:")]),e._v(" "),a("p",[a("code",[e._v("KEYRING_NAME('IZUKeyring.IZUDFLT')")])])]),e._v(" "),a("li",[a("p",[e._v("Substitute the value of the z/OSMF keyring that is obtained above from "),a("code",[e._v("bootstrap.properties")]),e._v(" in the value of the "),a("code",[e._v("--zosmf-keyring")]),e._v(" parameter:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("    su\n    cd $ZOWE_RUNTIME/api-mediation\n    scripts/apiml_cm.sh --action trust-zosmf --zosmf-keyring IZUKeyring.IZUDFLT --zosmf-userid IZUSVR\n")])])])])]),e._v(" "),a("p",[e._v("If the import is successful, restart the Zowe server to make the changes effective.")]),e._v(" "),a("p",[e._v("If the import is not successful, you may receive an error such as the following error:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("keytool error (likely untranslated): java.io.IOException: The private key of IZUDFLT is not available or no authority to access the private key\nIt is not possible to read z/OSMF keyring IZUSVR/IZUKeyring.IZUDFLT. The effective user ID was: acid. You need to run this command as user that has access to the z/OSMF keyring:\n")])])]),a("p",[e._v("Verify that you receive these messages in the log:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("ICH408I USER(acid ) GROUP(group ) NAME(name        )\n IRR.DIGTCERT.GENCERT CL(FACILITY)\n INSUFFICIENT ACCESS AUTHORITY\n FROM IRR.DIGTCERT.** (G)\n ACCESS INTENT(CONTROL)  ACCESS ALLOWED(NONE   )\n")])])]),a("p",[e._v("If you receive these messages, permit the user to have CONTROL access to "),a("code",[e._v("IRR.DIGTCERT.**")]),e._v(" with the following RACF command or the equivalent command for ACF2 or Top Secret:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("PERMIT IRR.DIGTCERT.** CLASS(FACILITY) ID(acid) ACCESS(CONTROL)\n")])])]),a("p",[e._v("If the import is successful, restart the Zowe server to make the changes effective.")]),e._v(" "),a("h4",{attrs:{id:"disable-certificate-validation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#disable-certificate-validation","aria-hidden":"true"}},[e._v("#")]),e._v(" Disable certificate validation")]),e._v(" "),a("p",[e._v("To use Zowe without setting up certificates, disable the validation of the TLS/SSL certificates by the API Mediation Layer.")]),e._v(" "),a("p",[e._v("Update the following property:")]),e._v(" "),a("p",[a("code",[e._v("-Dapiml.security.verifySslCertificatesOfServices=false")])]),e._v(" "),a("p",[e._v("in following shell scripts:")]),e._v(" "),a("ul",[a("li",[a("code",[e._v("$ZOWE_RUNTIME/api-mediation/scripts/api-mediation-start-catalog.sh")])]),e._v(" "),a("li",[a("code",[e._v("$ZOWE_RUNTIME/api-mediation/scripts/api-mediation-start-discovery.sh")])]),e._v(" "),a("li",[a("code",[e._v("$ZOWE_RUNTIME/api-mediation/scripts/api-mediation-start-gateway.sh")])])]),e._v(" "),a("h2",{attrs:{id:"security-service-client-library"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#security-service-client-library","aria-hidden":"true"}},[e._v("#")]),e._v(" Security Service Client Library")]),e._v(" "),a("p",[e._v("The "),a("code",[e._v("security-service-client-spring")]),e._v(" library enables authentication and endpoint protection. The library relies on API ML Gateway to provide authentication and token validation, and consists of the following components:")]),e._v(" "),a("ul",[a("li",[a("code",[e._v("com.ca.apiml.security.common")]),e._v(" - Components that are necessary to build Spring security")]),e._v(" "),a("li",[a("code",[e._v("com.ca.apiml.security.client")]),e._v(" - Components that enables the security client and Gateway lookup")])]),e._v(" "),a("h4",{attrs:{id:"enableapimlauth-annotation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#enableapimlauth-annotation","aria-hidden":"true"}},[e._v("#")]),e._v(" @EnableApimlAuth annotation")]),e._v(" "),a("p",[e._v("Use "),a("code",[e._v("@EnableApimlAuth")]),e._v(" annotation to enable the security client and integration of the "),a("code",[e._v("security-service-client-spring")]),e._v(" library. The annotation handles necessary component scans, creates the "),a("code",[e._v("GatewaySecurityService")]),e._v(", and starts the Gateway lookup logic.")]),e._v(" "),a("h4",{attrs:{id:"gateway-lookup-logic"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gateway-lookup-logic","aria-hidden":"true"}},[e._v("#")]),e._v(" Gateway lookup logic")]),e._v(" "),a("p",[e._v("Security client uses the "),a("code",[e._v("GatewayClient")]),e._v(" Spring component to represent a Gateway instance. Lookup logic scans the embedded Discovery client and sets a Gateway instance to ‘Gateway Client’ after the Spring context starts. The scanning process happens asynchronously from the context start-up. The security client provides the authentication service once the Gateway is found. Lookup status can be retrieved by calling "),a("code",[e._v("GatewayClient.isInitialized()")]),e._v(" method or listen for "),a("code",[e._v("GatewayLookupCompleteEvent")]),e._v(" event, which gets published after the Gateway instance is found.")]),e._v(" "),a("h4",{attrs:{id:"useful-classes"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#useful-classes","aria-hidden":"true"}},[e._v("#")]),e._v(" Useful classes")]),e._v(" "),a("p",[e._v("The core class of the library is "),a("code",[e._v("com.ca.apiml.security.client.service.GatewaySecurityService")]),e._v(", which provides a facility to perform login and to validate the jwt token. The "),a("code",[e._v("GatewaySecurityService")]),e._v(" has the following methods:")]),e._v(" "),a("ul",[a("li",[a("code",[e._v("login")]),e._v(" - Allows to login to the API Gateway with a username and password and retrieve the valid JWT token")]),e._v(" "),a("li",[a("code",[e._v("query")]),e._v(" - Allows to verify the JWT token validity and return the JWT token data")])]),e._v(" "),a("p",[e._v("The following providers process authentication requests:")]),e._v(" "),a("ul",[a("li",[a("code",[e._v("com.ca.apiml.security.client.login.GatewayLoginProvider")]),e._v(" - Verifies the mainframe credentials")]),e._v(" "),a("li",[a("code",[e._v("com.ca.apiml.security.client.token.GatewayTokenProvider")]),e._v(" - Authenticates the JWT token")])]),e._v(" "),a("p",[e._v("The library contains the following Spring security filters and handlers:")]),e._v(" "),a("ul",[a("li",[a("code",[e._v("com.ca.apiml.security.common.content.BasicContentFilter")]),e._v(" - Authenticates the credentials from the basic authorization header. The filter in the "),a("code",[e._v("SecurityConfiguration")]),e._v(" class is used to secure content with basic authentication. The credentials are extracted from the request header and are passed to the "),a("code",[e._v("GatewayLoginProvider")]),e._v(", which calls the "),a("code",[e._v("/login")]),e._v(" endpoint.")]),e._v(" "),a("li",[a("code",[e._v("com.ca.apiml.security.common.content.CookieContentFilter")]),e._v(" - Authenticates the JWT token that is stored in the cookie. This filter in a "),a("code",[e._v("SecurityConfiguration")]),e._v(" is used to secure content with the JWT token stored in the cookie. The JWT token is extracted from the cookie and passed to the "),a("code",[e._v("GatewayTokenProvider")]),e._v(", which calls the "),a("code",[e._v("/query")]),e._v(" endpoint.")]),e._v(" "),a("li",[a("code",[e._v("SuccessfulLoginHandler")]),e._v(" - Handles the successful login")]),e._v(" "),a("li",[a("code",[e._v("UnauthorizedHandler")]),e._v(" - Handles unauthorized access")]),e._v(" "),a("li",[a("code",[e._v("BasicAuthUnauthorizedHandler")]),e._v(" - Handles unauthorized access in the case of basic authentication")]),e._v(" "),a("li",[a("code",[e._v("FailedAuthenticationHandler")]),e._v(" - Handles authentication failure")]),e._v(" "),a("li",[a("code",[e._v("ResourceAccessExceptionHandler")]),e._v(" - Handles exceptions related to accessing other services/resources, such as GatewayNotFoundException or ServiceNotAccessibleException")]),e._v(" "),a("li",[a("code",[e._v("AuthExceptionHandler")]),e._v(" - Handles exceptions thrown during authentication process")])]),e._v(" "),a("p",[e._v("For more information, see "),a("a",{attrs:{href:"https://github.com/zowe/api-layer/blob/master/api-catalog-services/src/main/java/com/ca/mfaas/apicatalog/security/SecurityConfiguration.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("Api Catalog security configuration"),a("OutboundLink")],1),e._v(" (Reference usage of the library), "),a("a",{attrs:{href:"https://spring.io/guides/topicals/spring-security-architecture",target:"_blank",rel:"noopener noreferrer"}},[e._v("Spring Security Architecture"),a("OutboundLink")],1),e._v(" and "),a("a",{attrs:{href:"https://www.baeldung.com/security-spring",target:"_blank",rel:"noopener noreferrer"}},[e._v("Security with Spring Tutorial"),a("OutboundLink")],1),e._v(".")])])},[],!1,null,null,null);t.default=r.exports}}]);